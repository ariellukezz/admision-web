import{r,C as Y,H as _e,e as Z,o as c,c as g,a as t,w as a,B as ge,M as be,b as i,d as l,t as y,f as $,E as ee,u as C,y as I,a5 as f,I as ye,_ as xe,L as he,K as ke,aQ as we,h as Ce,k as De,l as Ue,S as Ee,j as Se,m as Fe,a8 as Le,q as Oe}from"./app-d94ab509.js";import{_ as ze}from"./_plugin-vue_export-helper-c27b6911.js";import{F as Be}from"./FileTextOutlined-fed66a23.js";import{E as Re}from"./EyeOutlined-acf66a04.js";import{D as $e}from"./DownloadOutlined-f83b0136.js";import{D as te}from"./DeleteOutlined-7dacb522.js";import{U as Ie}from"./UploadOutlined-1ef920b1.js";import"./AntdIcon-c56eb973.js";const Me={class:"crud-container"},je={class:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 p-4 bg-gray-50 rounded-lg"},Te={class:"flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full"},Ne={class:"flex gap-2"},Pe={key:0,class:"flex items-center gap-2"},Ae=["onClick"],Ve={key:2,class:"text-gray-600 font-medium"},Ge={class:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors"},We={key:1,class:"text-left"},qe={class:"flex items-center justify-between mb-4"},He={class:"flex items-center gap-3"},Ke={class:"font-medium text-gray-800"},Qe={class:"text-sm text-gray-500"},Je={class:"mt-4"},Xe={class:"border rounded-lg p-4 bg-gray-50 max-h-80 overflow-y-auto"},Ye=["src"],Ze={key:1,class:"text-center text-gray-500 py-8"},et={class:"flex justify-end gap-3 mt-6 pt-4 border-t"},tt={class:"pdf-viewer-container"},ot={class:"flex justify-between items-center mb-4 p-4 bg-gray-50 rounded-lg"},at={class:"font-semibold text-lg text-gray-800"},st={class:"pdf-frame-container"},lt=["src"],nt={key:1,class:"flex justify-center items-center h-96"},rt={class:"text-center"},it={__name:"documentos_observacion",setup(ut){const L=r(!1),O=r(!1),D=r(!1),M=r(!1),j=r(!1),U=r(""),z=r([]),p=r(null),_=r(""),T=r(null),u=r(""),x=r(null),h=r(""),N=r(),m=Y({nombre:"",tipo:"general",archivo:null}),oe={nombre:[{required:!0,message:"El nombre es obligatorio"},{min:3,message:"Mínimo 3 caracteres"}],tipo:[{required:!0,message:"El tipo es obligatorio"}]},ae=[{title:"ID",dataIndex:"id",key:"id",width:70,align:"center"},{title:"NOMBRE",dataIndex:"nombre",key:"nombre",width:240,ellipsis:!0},{title:"TIPO",dataIndex:"tipo",key:"tipo",width:140,align:"center"},{title:"FECHA SUBIDA",dataIndex:"fecha_subida",key:"fecha_subida",width:140,align:"center"},{title:"ACCIONES",key:"actions",width:120,align:"center",fixed:"right"}],W=Y({current:1,pageSize:10,total:0,showSizeChanger:!0,showQuickJumper:!0,showTotal:(o,e)=>`${e[0]}-${e[1]} de ${o} documentos`}),se=_e(()=>U.value?z.value.filter(o=>o.nombre.toLowerCase().includes(U.value.toLowerCase())||o.tipo.toLowerCase().includes(U.value.toLowerCase())):z.value),P=async()=>{M.value=!0;try{const o=await I.get("https://servicios-admision.unap.edu.pe/api/v1/observados/documentos");z.value=o.data.data||o.data,W.total=z.value.length}catch(o){f.error("Error al cargar los documentos"),console.error(o)}finally{M.value=!1}},q=async o=>{x.value=o,D.value=!0;try{const e=await I.get(`https://servicios-admision.unap.edu.pe/api/v1/observados/documentos/${o.id}/descargar`,{responseType:"arraybuffer"}),s=new Blob([e.data],{type:"application/pdf"});h.value=URL.createObjectURL(s)}catch(e){console.error("❌ Error al cargar el documento:",e),f.error("Error al cargar el documento")}},H=async o=>{try{const s=await(await fetch(`https://servicios-admision.unap.edu.pe/api/v1/observados/documentos/${o.id}/descargar`)).text(),v=unescape(encodeURIComponent(s)),B=new Uint8Array(v.length);for(let k=0;k<v.length;k++)B[k]=v.charCodeAt(k)&255;const E=new Blob([B],{type:"application/pdf"}),R=URL.createObjectURL(E),b=document.createElement("a");b.href=R,b.download=`${o.nombre}.pdf`,document.body.appendChild(b),b.click(),document.body.removeChild(b),setTimeout(()=>URL.revokeObjectURL(R),5e3),f.success("PDF descargado correctamente")}catch(e){console.error("Error:",e),f.error("Error al descargar el PDF")}},le=()=>{Object.assign(m,{nombre:"",tipo:"general",archivo:null}),p.value=null,_.value="",u.value="",O.value=!0},ne=o=>{const e=o.target.files[0];if(u.value="",!e)return;if(e.type!=="application/pdf"){u.value="Solo se permiten archivos PDF";return}if(!(e.size/1024/1024<10)){u.value="El archivo debe ser menor a 10MB";return}p.value=e,m.archivo=e,re(e)},re=o=>{_.value&&URL.revokeObjectURL(_.value),_.value=URL.createObjectURL(o)},K=()=>{p.value=null,m.archivo=null,u.value="",_.value&&(URL.revokeObjectURL(_.value),_.value=""),T.value&&(T.value.value="")},ie=o=>{if(o===0)return"0 Bytes";const e=1024,s=["Bytes","KB","MB","GB"],v=Math.floor(Math.log(o)/Math.log(e));return parseFloat((o/Math.pow(e,v)).toFixed(2))+" "+s[v]},Q=async()=>{var o,e;try{if(await N.value.validate(),!p.value){u.value="Seleccione un archivo PDF";return}if(u.value)return;j.value=!0;const s=new FormData;s.append("nombre",m.nombre),s.append("tipo",m.tipo),s.append("archivo",p.value);const v=await I.post("https://servicios-admision.unap.edu.pe/api/v1/observados/documentos",s,{headers:{"Content-Type":"multipart/form-data"},timeout:3e4});f.success("Documento subido correctamente"),await P(),A()}catch(s){if(s.errorFields){p.value||(u.value="Seleccione un archivo PDF");return}(e=(o=s.response)==null?void 0:o.data)!=null&&e.error?f.error(`${s.response.data.error}`):s.code==="ECONNABORTED"?f.error("Tiempo de espera agotado. Intente nuevamente."):f.error("Error al subir el documento"),console.error("Error detallado:",s)}finally{j.value=!1}},ue=async o=>{try{await I.delete(`https://servicios-admision.unap.edu.pe/api/v1/observados/documentos/${o}`),f.success("Documento eliminado correctamente"),await P()}catch(e){f.error("Error al eliminar el documento"),console.error(e)}},de=o=>({general:"blue",contrato:"green",informe:"orange",formulario:"purple",oficio:"red"})[o]||"default",ce=o=>new Date(o).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}),A=()=>{var o;O.value=!1,(o=N.value)==null||o.resetFields(),K(),u.value=""};return Z(D,o=>{!o&&h.value&&(URL.revokeObjectURL(h.value),h.value="",x.value=null)}),Z(L,o=>{o&&P()}),(o,e)=>{const s=ge,v=ye,B=xe,E=he,R=ke,b=we,k=Ce,V=De,J=Ue,S=Ee,pe=Se,me=Fe,X=Le,ve=Oe,G=be;return c(),g("div",null,[t(s,{type:"primary",onClick:e[0]||(e[0]=F=>L.value=!0),class:"mb-4"},{default:a(()=>e[10]||(e[10]=[i(" Gestionar Documentos ")])),_:1}),t(G,{open:L.value,"onUpdate:open":e[9]||(e[9]=F=>L.value=F),title:"Gestión de Documentos",width:"95%",footer:null,styles:{maxWidth:"1400px"}},{default:a(()=>{var F;return[l("div",Me,[l("div",je,[l("div",Te,[t(v,{value:U.value,"onUpdate:value":e[1]||(e[1]=n=>U.value=n),placeholder:"Buscar por nombre o tipo...",style:{width:"100%",maxWidth:"300px"},size:"large"},null,8,["value"]),l("div",Ne,[t(s,{type:"primary",onClick:le,class:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700",size:"large"},{default:a(()=>e[11]||(e[11]=[i(" Subir Documento ")])),_:1})])])]),t(k,{columns:ae,"data-source":se.value,loading:M.value,pagination:W,"row-key":"id",scroll:{x:600},class:"custom-table",size:"middle"},{bodyCell:a(({column:n,record:d})=>[n.key==="nombre"?(c(),g("div",Pe,[l("span",{class:"font-medium text-gray-800 cursor-pointer hover:text-blue-600",onClick:w=>q(d)},y(d.nombre),9,Ae)])):$("",!0),n.key==="tipo"?(c(),ee(B,{key:1,color:de(d.tipo),class:"font-semibold px-3 py-1 rounded-full"},{default:a(()=>[i(y(d.tipo.toUpperCase()),1)]),_:2},1032,["color"])):$("",!0),n.key==="fecha_subida"?(c(),g("div",Ve,y(ce(d.fecha_subida)),1)):$("",!0),n.key==="actions"?(c(),ee(b,{key:3,size:"middle"},{default:a(()=>[t(E,{title:"Ver documento"},{default:a(()=>[t(s,{type:"link",size:"small",onClick:w=>q(d),class:"text-blue-600 hover:text-blue-800 p-0"},{default:a(()=>[t(C(Re))]),_:2},1032,["onClick"])]),_:2},1024),t(E,{title:"Descargar"},{default:a(()=>[t(s,{type:"link",size:"small",onClick:w=>H(d),class:"text-green-600 hover:text-green-800 p-0"},{default:a(()=>[t(C($e))]),_:2},1032,["onClick"])]),_:2},1024),t(E,{title:"Eliminar"},{default:a(()=>[t(R,{title:"¿Estás seguro de eliminar este documento?","ok-text":"Sí","cancel-text":"No",onConfirm:w=>ue(d.id)},{default:a(()=>[t(s,{type:"link",danger:"",size:"small",class:"hover:text-red-700 p-0"},{default:a(()=>[t(C(te))]),_:1})]),_:2},1032,["onConfirm"])]),_:2},1024)]),_:2},1024)):$("",!0)]),_:1},8,["data-source","loading","pagination"]),t(G,{open:O.value,"onUpdate:open":e[5]||(e[5]=n=>O.value=n),title:"Subir Nuevo Documento",onCancel:A,width:"90%",styles:{maxWidth:"800px"},maskClosable:!1,footer:null},{default:a(()=>[t(ve,{ref_key:"formRef",ref:N,model:m,rules:oe,layout:"vertical",class:"space-y-4",onSubmit:Q},{default:a(()=>[t(me,{gutter:16},{default:a(()=>[t(J,{xs:24,sm:12},{default:a(()=>[t(V,{label:"Nombre del documento",name:"nombre"},{default:a(()=>[t(v,{value:m.nombre,"onUpdate:value":e[2]||(e[2]=n=>m.nombre=n),placeholder:"Ingrese el nombre del documento",size:"large"},null,8,["value"])]),_:1})]),_:1}),t(J,{xs:24,sm:12},{default:a(()=>[t(V,{label:"Tipo de documento",name:"tipo"},{default:a(()=>[t(pe,{value:m.tipo,"onUpdate:value":e[3]||(e[3]=n=>m.tipo=n),placeholder:"Seleccione el tipo de documento",size:"large"},{default:a(()=>[t(S,{value:"general"},{default:a(()=>e[12]||(e[12]=[i("General")])),_:1}),t(S,{value:"contrato"},{default:a(()=>e[13]||(e[13]=[i("Contrato")])),_:1}),t(S,{value:"informe"},{default:a(()=>e[14]||(e[14]=[i("Informe")])),_:1}),t(S,{value:"formulario"},{default:a(()=>e[15]||(e[15]=[i("Formulario")])),_:1}),t(S,{value:"oficio"},{default:a(()=>e[16]||(e[16]=[i("Oficio")])),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),t(V,{label:"Seleccionar PDF",name:"archivo","validate-status":u.value?"error":"",help:u.value},{default:a(()=>[l("div",Ge,[l("input",{type:"file",ref_key:"fileInput",ref:T,onChange:ne,accept:".pdf",class:"hidden"},null,544),p.value?(c(),g("div",We,[l("div",qe,[l("div",He,[t(C(Be),{class:"text-blue-500 text-xl"}),l("div",null,[l("div",Ke,y(p.value.name),1),l("div",Qe,y(ie(p.value.size)),1)])]),t(s,{type:"link",onClick:K,class:"text-red-500"},{default:a(()=>[t(C(te)),e[18]||(e[18]=i(" Eliminar "))]),_:1})]),l("div",Je,[e[20]||(e[20]=l("div",{class:"text-sm font-medium text-gray-700 mb-2"},"Vista previa:",-1)),l("div",Xe,[_.value?(c(),g("iframe",{key:0,src:_.value,class:"w-full h-64 border-0",frameborder:"0"},null,8,Ye)):(c(),g("div",Ze,[t(X,{size:"large"}),e[19]||(e[19]=l("div",{class:"mt-2"},"Cargando vista previa...",-1))]))])])])):(c(),g("div",{key:0,class:"cursor-pointer",onClick:e[4]||(e[4]=n=>o.$refs.fileInput.click())},e[17]||(e[17]=[l("div",{class:"text-lg font-medium text-gray-600"},"Click para seleccionar PDF",-1),l("div",{class:"text-sm text-gray-500 mt-1"},"Máximo 10MB",-1)])))])]),_:1},8,["validate-status","help"])]),_:1},8,["model"]),l("div",et,[t(s,{onClick:A,size:"large"},{default:a(()=>e[21]||(e[21]=[i(" Cancelar ")])),_:1}),t(s,{type:"primary",onClick:Q,loading:j.value,disabled:!p.value,size:"large",class:"bg-blue-600 hover:bg-blue-700"},{default:a(()=>[t(C(Ie)),e[22]||(e[22]=i(" Subir Documento "))]),_:1},8,["loading","disabled"])])]),_:1},8,["open"]),t(G,{open:D.value,"onUpdate:open":e[8]||(e[8]=n=>D.value=n),title:`Documento: ${((F=x.value)==null?void 0:F.nombre)||""}`,width:"95%",styles:{maxWidth:"1200px",top:"20px"},footer:null,maskClosable:!0,class:"pdf-modal"},{default:a(()=>{var n,d,w;return[l("div",tt,[l("div",ot,[l("div",at,y((n=x.value)==null?void 0:n.nombre)+" - "+y((w=(d=x.value)==null?void 0:d.tipo)==null?void 0:w.toUpperCase()),1),t(b,null,{default:a(()=>[t(s,{onClick:e[6]||(e[6]=fe=>H(x.value)),icon:"download",type:"primary",class:"bg-green-600 hover:bg-green-700"},{default:a(()=>e[23]||(e[23]=[i(" Descargar ")])),_:1}),t(s,{onClick:e[7]||(e[7]=fe=>D.value=!1)},{default:a(()=>e[24]||(e[24]=[i(" Cerrar ")])),_:1})]),_:1})]),l("div",st,[h.value?(c(),g("iframe",{key:0,src:h.value,class:"pdf-iframe",frameborder:"0"},null,8,lt)):(c(),g("div",nt,[l("div",rt,[t(X,{size:"large"}),e[25]||(e[25]=l("div",{class:"mt-4 text-gray-600"},"Cargando documento...",-1))])]))])])]}),_:1},8,["open","title"])])]}),_:1},8,["open"])])}}},bt=ze(it,[["__scopeId","data-v-ee2ce2df"]]);export{bt as default};
